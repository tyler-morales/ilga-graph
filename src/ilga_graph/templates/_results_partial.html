{# Partial template: swapped into #results by htmx. No base.html wrapper. #}

{% if seed_mode is defined and seed_mode %}
<div class="seed-notice">
    <strong>Dev/Seed mode.</strong>
    {% if member_count is defined and member_count < 100 %}
    Only {{ member_count }} of 177 legislators are loaded.
    {% endif %}
    {% if zip_count is defined and zip_count < 100 %}
    District data uses ~{{ zip_count }} demo ZIPs (not full Census).
    {% endif %}
    Some districts may show no results.
    To test with <strong>full data</strong> (all members + all IL ZIPs), run <code>make run</code> or set <code>ILGA_SEED_MODE=0</code> (after <code>make scrape</code>).
</div>
{% endif %}

{% if error %}
<div class="error-msg">{{ error }}</div>
{% endif %}

{# ── Member card macro ─────────────────────────────────────────────────── #}
{# script_hint is now read from the card dict (member.script_hint).          #}
{# Cross-party % only shown when member has at least one substantive bill  #}
{# (otherwise 0% would mean "no data" and is misleading).                   #}

{% macro member_card(member, role_label, role_class) %}
<div class="card">
    {% for badge in member.badges %}
    <span class="role-label role-badge">{{ badge }}</span>
    {% endfor %}
    {% if not member.badges %}
    <span class="role-label {{ role_class }}">{{ role_label }}</span>
    {% endif %}
    <h3>{{ member.name }}</h3>
    <dl>
        <dt>District</dt>
        <dd>{{ member.chamber }} District {{ member.district }}</dd>

        <dt>Party</dt>
        <dd>{{ member.party }}</dd>

        {% if member.phone %}
        <dt>Office Phone</dt>
        <dd><a href="tel:{{ member.phone }}">{{ member.phone }}</a></dd>
        {% endif %}

        {# Empirical stats: only show when we have data #}
        {% if member.laws_passed is not none and member.laws_filed is not none %}
        <dt>Laws passed</dt>
        <dd>{{ member.laws_passed }} of {{ member.laws_filed }} filed ({{ member.passage_rate_pct or 0 }}% passage rate)</dd>
        {% endif %}

        {# Cross-party % only when we have substantive bills to measure (else 0% is misleading) #}
        {% if member.bridge_pct is not none and member.laws_filed and member.laws_filed > 0 %}
        <dt>Cross-party co-sponsorship</dt>
        <dd>{{ member.bridge_pct }}%</dd>
        {% endif %}

        {# Derived: composite rank with tooltip #}
        {% if member.moneyball_score is not none %}
        <dt title="{{ member.moneyball_explanation|e }}">Moneyball <span class="metric-help" title="{{ member.moneyball_explanation|e }}">?</span></dt>
        <dd>{{ member.moneyball_score }} <span class="metric-note">(composite rank 0&ndash;100)</span></dd>
        {% endif %}
    </dl>
    {% if member.why %}
    <div class="why-chosen">
        <strong>Why this target:</strong> {{ member.why }}
    </div>
    {% endif %}
    {% if member.script_hint %}
    <div class="script-hint">
        <strong>Script Hint:</strong> {{ member.script_hint }}
    </div>
    {% endif %}
</div>
{% endmacro %}

{# ── Two-column layout when we have cards: aside = How we pick; main = scrollable cards ── #}

{% if senator or representative or broker or ally or super_ally %}
<div class="results-layout">
    <aside class="results-aside">
        <div class="how-it-works">
            <h3 class="hiw-title">How we pick these targets</h3>
            <div class="hiw-body">
                <dl>
                    <dt>Your Senator &amp; Representative</dt>
                    <dd>ZIP is matched to IL Senate/House districts via Census (ZCTA). These are your reps.</dd>

                    <dt>Power Broker</dt>
                    <dd>With a <strong>policy category</strong>: the <strong>committee chair</strong> for that topic. Otherwise: Senate member (not your district) with the <strong>highest Moneyball score</strong>.</dd>

                    <dt>Potential Ally</dt>
                    <dd>Senator who <strong>sits next to yours</strong> and has the <strong>highest cross-party co-sponsorship rate</strong> among those seatmates.</dd>

                    <dt>Super Ally</dt>
                    <dd>When Power Broker and Ally are the <strong>same person</strong> &mdash; merged into one card.</dd>
                </dl>
                <details class="hiw-details">
                    <summary>Moneyball formula</summary>
                    <table class="formula-table">
                        <tr><th>Factor</th><th>Wt</th><th>Measures</th></tr>
                        <tr><td>Passage rate</td><td>24%</td><td>Laws passed &divide; filed</td></tr>
                        <tr><td>Pipeline depth</td><td>16%</td><td>How far bills go (0&ndash;6)</td></tr>
                        <tr><td>Co-sponsor pull</td><td>16%</td><td>Avg co-sponsors vs max</td></tr>
                        <tr><td>Cross-party rate</td><td>12%</td><td>Bills with opposite-party co-sponsor</td></tr>
                        <tr><td>Network centrality</td><td>12%</td><td>Unique co-sponsorship peers</td></tr>
                        <tr><td>Institutional role</td><td>20%</td><td>Leadership bonus</td></tr>
                    </table>
                </details>
            </div>
        </div>
    </aside>
    <main class="results-main">
{% endif %}

{# ── Your Legislators ── #}

{% if senator or representative %}
<h2>Your Legislators (ZIP {{ zip }})</h2>
<p class="section-desc">These are the people who represent you. They work for you and must hear from constituents.</p>
{% endif %}

{% if senator %}
{{ member_card(senator, "Your Senator", "role-senator") }}
{% endif %}

{% if representative %}
{{ member_card(representative, "Your Representative", "role-rep") }}
{% endif %}

{# ── Strategic Targets ── #}

{% if super_ally or broker or ally %}
<h2>Strategic Targets{% if category %} &mdash; {{ category }}{% endif %}</h2>
<p class="section-desc">
    {% if category %}
    Filtered to legislators on <strong>{{ category }}</strong> committees.
    {% else %}
    These legislators were identified by our analytics engine as high-impact advocacy targets beyond your own district.
    {% endif %}
</p>
{% endif %}

{% if super_ally %}
{{ member_card(super_ally, "Super Ally", "role-super-ally") }}
{% endif %}

{% if broker %}
{{ member_card(broker, "Power Broker", "role-broker") }}
{% endif %}

{% if ally %}
{{ member_card(ally, "Potential Ally", "role-ally") }}
{% endif %}

{% if senator or representative or broker or ally or super_ally %}
    </main>
</div>
{% endif %}
